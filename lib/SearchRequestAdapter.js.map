{"version":3,"sources":["../src/SearchRequestAdapter.js"],"names":["SearchRequestAdapter","facetFilters","adaptedResult","intermediateFacetFilters","facetName","facetValue","facetFilter","facet","values","numericFilters","numericFilter","adaptedFilters","filter","indexName","params","typesenseSearchParams","q","query_by","facet_by","filter_by","sort_by","max_facet_values","page"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;IAEaA,oB;;;;;wBAC4B;AACrC,aAAO,IAAA,MAAA,CAAP,0BAAO,CAAP;AACD;;;AAED,WAAA,oBAAA,CAAA,oBAAA,EAAA,eAAA,EAAA,cAAA,EAAmE;AAAA,KAAA,GAAA,gBAAA,CAAA,SAAA,CAAA,EAAA,IAAA,EAAA,oBAAA;AACjE,SAAA,oBAAA,GAAA,oBAAA;AACA,SAAA,eAAA,GAAA,eAAA;AACA,SAAA,cAAA,GAAA,cAAA;AACD;;;;uCAEkBC,Y,EAAc;AAC/B,UAAIC,aAAa,GAAjB,EAAA;;AAEA,UAAI,CAAJ,YAAA,EAAmB;AACjB,eAAA,aAAA;AACD;;AAED,UAAMC,wBAAwB,GAPC,EAO/B,CAP+B,CAS/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAF,MAAAA,YAAY,CAAZA,IAAAA,GAAAA,OAAAA,CAA4B,UAAA,WAAA,EAAe;AAAA,YAAA,kBAAA,GACTK,WAAW,CAAXA,KAAAA,CADS,GACTA,CADS;AAAA,YAAA,mBAAA,GAAA,CAAA,GAAA,eAAA,CAAA,SAAA,CAAA,EAAA,kBAAA,EAAA,CAAA,CAAA;AAAA,YAClCF,SADkC,GAAA,mBAAA,CAAA,CAAA,CAAA;AAAA,YACvBC,UADuB,GAAA,mBAAA,CAAA,CAAA,CAAA;;AAEzCF,QAAAA,wBAAwB,CAAxBA,SAAwB,CAAxBA,GACEA,wBAAwB,CAAxBA,SAAwB,CAAxBA,IADFA,EAAAA;AAEAA,QAAAA,wBAAwB,CAAxBA,SAAwB,CAAxBA,CAAAA,IAAAA,CAAAA,UAAAA;AAtB6B,OAkB/BF,EAlB+B,CAyB/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAC,MAAAA,aAAa,GAAG,MAAM,CAAN,OAAA,CAAA,wBAAA,EAAA,GAAA,CACT,UAAA,IAAA,EAAA;AAAA,YAAA,KAAA,GAAA,CAAA,GAAA,eAAA,CAAA,SAAA,CAAA,EAAA,IAAA,EAAA,CAAA,CAAA;AAAA,YAAEK,KAAF,GAAA,KAAA,CAAA,CAAA,CAAA;AAAA,YAASC,MAAT,GAAA,KAAA,CAAA,CAAA,CAAA;;AAAA,eACH,GAAA,MAAA,CAAA,KAAA,EAAA,KAAA,EAAA,MAAA,CAA+BA,MAAM,CAANA,IAAAA,CAA/B,GAA+BA,CAA/B,EADG,GACH,CADG;AADS,OAAA,EAAA,IAAA,CAAhBN,MAAgB,CAAhBA;AAMA,aAAA,aAAA;AACD;;;yCAEoBO,c,EAAgB;AACnC,UAAIP,aAAa,GAAjB,EAAA;;AAEA,UAAI,CAAJ,cAAA,EAAqB;AACnB,eAAA,aAAA;AACD;;AAEDA,MAAAA,aAAa,GAAG,cAAc,CAAd,GAAA,CACT,UAAA,aAAA,EAAa;AAAA,eAAIQ,aAAa,CAAbA,OAAAA,CAAsB,IAAA,MAAA,CAAtBA,QAAsB,CAAtBA,EAAJ,KAAIA,CAAJ;AADJ,OAAA,EAAA,IAAA,CAAhBR,MAAgB,CAAhBA;AAIA,aAAA,aAAA;AACD;;;kCAEaD,Y,EAAcQ,c,EAAgB;AAC1C,UAAME,cAAc,GAApB,EAAA;AAEAA,MAAAA,cAAc,CAAdA,IAAAA,CAAoB,KAAA,kBAAA,CAApBA,YAAoB,CAApBA;AACAA,MAAAA,cAAc,CAAdA,IAAAA,CAAoB,KAAA,oBAAA,CAApBA,cAAoB,CAApBA;AAEA,aAAO,cAAc,CAAd,MAAA,CAAsB,UAAA,MAAA,EAAM;AAAA,eAAIC,MAAM,KAAV,EAAA;AAA5B,OAAA,EAAA,IAAA,CAAP,MAAO,CAAP;AACD;;;oCAEeC,S,EAAW;AACzB,aAAOA,SAAS,CAATA,KAAAA,CAAgB,KAAA,WAAA,CAAhBA,yBAAAA,EAAP,CAAOA,CAAP;AACD;;;iCAEYA,S,EAAW;AACtB,aAAOA,SAAS,CAATA,KAAAA,CAAgB,KAAA,WAAA,CAAhBA,yBAAAA,EAAP,CAAOA,CAAP;AACD;;;6CAEwB;AACvB,UAAMC,MAAM,GAAG,KAAA,oBAAA,CAAf,MAAA;AACA,UAAMD,SAAS,GAAG,KAAA,oBAAA,CAAlB,SAAA;AACA,UAAME,qBAAqB,GAAG;AAC5BC,QAAAA,CAAC,EAAEF,MAAM,CAANA,KAAAA,KAAAA,EAAAA,GAAAA,GAAAA,GAA4BA,MAAM,CADT,KAAA;AAE5BG,QAAAA,QAAQ,EAAE,KAAA,cAAA,CAAA,IAAA,CAFkB,GAElB,CAFkB;AAG5BC,QAAAA,QAAQ,EAAE,CAACJ,MAAM,CAAP,MAAA,EAAA,IAAA,GAAA,IAAA,CAHkB,GAGlB,CAHkB;AAI5BK,QAAAA,SAAS,EAAE,KAAA,aAAA,CAAmBL,MAAM,CAAzB,YAAA,EAAwCA,MAAM,CAJ7B,cAIjB,CAJiB;AAK5BM,QAAAA,OAAO,EAAE,KAAA,YAAA,CALmB,SAKnB,CALmB;AAM5BC,QAAAA,gBAAgB,EAAEP,MAAM,CANI,iBAAA;AAO5BQ,QAAAA,IAAI,EAAER,MAAM,CAANA,IAAAA,GAAc;AAPQ,OAA9B;;AAUA,UAAIA,MAAM,CAAV,UAAA,EAAuB;AACrBC,QAAAA,qBAAqB,CAArBA,WAAAA,GAAAA,GAAAA,MAAAA,CAAuCD,MAAM,CAA7CC,SAAAA,EAAAA,GAAAA,EAAAA,MAAAA,CAA2DD,MAAM,CAAjEC,UAAAA,CAAAA;AACAA,QAAAA,qBAAqB,CAArBA,QAAAA,GAAAA,CAAAA;AACAA,QAAAA,qBAAqB,CAArBA,QAAAA,GAAAA,CAAAA;AACD;;AAED,aAAA,qBAAA;AACD;;;;;;;;;;;iDAGQ,KAAA,eAAA,CAAA,WAAA,CACQ,KAAA,eAAA,CAAqB,KAAA,oBAAA,CAD7B,SACQ,CADR,EAAA,SAAA,GAAA,MAAA,CAGG,KAHH,sBAGG,EAHH,C","sourcesContent":["\"use strict\";\n\nexport class SearchRequestAdapter {\n  static get INDEX_NAME_MATCHING_REGEX() {\n    return new RegExp(\"^(.+?)(?=(/sort/(.*))|$)\");\n  }\n\n  constructor(instantsearchRequest, typesenseClient, searchByFields) {\n    this.instantsearchRequest = instantsearchRequest;\n    this.typesenseClient = typesenseClient;\n    this.searchByFields = searchByFields;\n  }\n\n  _adaptFacetFilters(facetFilters) {\n    let adaptedResult = \"\";\n\n    if (!facetFilters) {\n      return adaptedResult;\n    }\n\n    const intermediateFacetFilters = {};\n\n    // Need to transform:\n    // faceFilters = [[\"facet1:value1\", \"facet1:value2\"], \"facet2:value3\"]]\n    //\n    // Into this:\n    // intermediateFacetFilters = {\n    //     \"facet1\": [\"value1\", \"value2\"],\n    //     \"facet2\": [\"value1\", \"value2\"]\n    // }\n\n    facetFilters.flat().forEach(facetFilter => {\n      const [facetName, facetValue] = facetFilter.split(\":\");\n      intermediateFacetFilters[facetName] =\n        intermediateFacetFilters[facetName] || [];\n      intermediateFacetFilters[facetName].push(facetValue);\n    });\n\n    // Need to transform this:\n    // intermediateFacetFilters = {\n    //     \"facet1\": [\"value1\", \"value2\"],\n    //     \"facet2\": [\"value1\", \"value2\"]\n    // }\n    //\n    // Into this:\n    // facet1: [value1,value2] && facet2: [value1,value2]\n\n    adaptedResult = Object.entries(intermediateFacetFilters)\n      .map(([facet, values]) =>\n        \"\".concat(facet, \": [\").concat(values.join(\",\"), \"]\")\n      )\n      .join(\" && \");\n\n    return adaptedResult;\n  }\n\n  _adaptNumericFilters(numericFilters) {\n    let adaptedResult = \"\";\n\n    if (!numericFilters) {\n      return adaptedResult;\n    }\n\n    adaptedResult = numericFilters\n      .map(numericFilter => numericFilter.replace(new RegExp(\"(>|<=)\"), \":$1\"))\n      .join(\" && \");\n\n    return adaptedResult;\n  }\n\n  _adaptFilters(facetFilters, numericFilters) {\n    const adaptedFilters = [];\n\n    adaptedFilters.push(this._adaptFacetFilters(facetFilters));\n    adaptedFilters.push(this._adaptNumericFilters(numericFilters));\n\n    return adaptedFilters.filter(filter => filter !== \"\").join(\" && \");\n  }\n\n  _adaptIndexName(indexName) {\n    return indexName.match(this.constructor.INDEX_NAME_MATCHING_REGEX)[1];\n  }\n\n  _adaptSortBy(indexName) {\n    return indexName.match(this.constructor.INDEX_NAME_MATCHING_REGEX)[3];\n  }\n\n  _buildSearchParameters() {\n    const params = this.instantsearchRequest.params;\n    const indexName = this.instantsearchRequest.indexName;\n    const typesenseSearchParams = {\n      q: params.query === \"\" ? \"*\" : params.query,\n      query_by: this.searchByFields.join(\",\"),\n      facet_by: [params.facets].flat().join(\",\"),\n      filter_by: this._adaptFilters(params.facetFilters, params.numericFilters),\n      sort_by: this._adaptSortBy(indexName),\n      max_facet_values: params.maxValuesPerFacet,\n      page: params.page + 1\n    };\n\n    if (params.facetQuery) {\n      typesenseSearchParams.facet_query = `${params.facetName}:${params.facetQuery}`;\n      typesenseSearchParams.max_hits = 1;\n      typesenseSearchParams.per_page = 1;\n    }\n\n    return typesenseSearchParams;\n  }\n\n  async request() {\n    return this.typesenseClient\n      .collections(this._adaptIndexName(this.instantsearchRequest.indexName))\n      .documents()\n      .search(this._buildSearchParameters());\n  }\n}\n"],"file":"SearchRequestAdapter.js"}